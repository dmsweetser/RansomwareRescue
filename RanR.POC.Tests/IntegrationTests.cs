using Microsoft.VisualStudio.TestTools.UnitTesting;
using Newtonsoft.Json;
using RanR.POC.Helpers;
using RanR.POC.Logging;
using RanR.POC.Operations;
using RanR.POC.SolutionDefinitions;
using RanR.POC.SolutionManagement;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq.Expressions;
using System.Numerics;
using System.Reflection;
using System.Threading;

namespace RanR.POC.Tests
{
    [TestClass]
    public class IntegrationTests
    {
 
        [TestMethod]
        public void generate_and_execute_found_solution_for_simple_file_with_provided_x()
        {
            var tokenSource = new CancellationTokenSource();
            var token = tokenSource.Token;
            var solutionRepository = new SolutionRepository(tokenSource);
            var assembly = Assembly.GetExecutingAssembly();
            var initializer = new Initializer();

            //Note that this is a precalculated value, so it will immediately pass
            initializer.InitialValueForX = "10206185567010309278350277510257047233733024740708817322922013778458916054727997150102815170377067981959817731631363755389022916910994953073682049803343286951793549234041911355499722351488748116104145979044942491126586208762832301095744820102323383234602133655178970150837884891398476657199658214865988945604986141332657409642303264965381625743599570684293332678711746708196091291175579727378782411867515739425623008215596110767258364608915515302553721141413427203927201297136011223571334388962076667814351576303978084389025063673402792813595928172772721909896680167419323095550201187069333074551142227623872715105221541907471899598717789012382587385528939549552295981012020675482527443857373716592104954512630084827208915284095389170588811366463134178528925911645236669401148844130682555802794254123405574828495502315164800388790342562630037678808050869075326756008831681410565750867434169611859393761839549880727952510213427679216696224271451759077093493676405163403224598301815103266583994990775777268913677808431377770451564403727591722769778578282438689792637131717344769298918013622070473367143077952405500997716719367891727410284421423266882344546272261745857555466763671809066038869634139197692144208023239343070743916147778237579839326947891826392907954708137465933831499358490034072752891975794627237024998735107444313818942049178213465563328595330602732553848925130410907995517049528290883963589398989982246635781800405806923797460131445079955615841966044473131176908970150827290765888184201266606336501940842485030085210130944651773097677191408334042685401302041730925313502036922954268919727269168757370197475914330274558808653258709740723417691181751971329503170527797920976655849788439543816307197007638936191852535371022414440400021863659906703642160268301690080569325870632147599884628974012693589947868828237762485154939583223041055752246960562667030309130905072286598874650641193140500588059996985502356128869861596854404395308572820419000905486604205352649196558570233741572118047389469050392022192955078049470775349636323576816190664964813148232560680458934473516327276906981779873879230528220745712934608566641456540121206983423029706354340579547506705411575406939126760825294998201575959706333084390051179492724769017961667129185932501809239875175193831004264523107984671886990333350940138285660623749127982472734537635608360851082880283619950242559016953241938948324213020750591526789263792150365117242266385290001311898799952993389361517122876322276902963770582286192433442904119132068569069706837973556863814592405367718529420882582482763851930202869433681628565475736883670430576500931126823865237308837892612061335795357981750615778930291041120388747526643710823967594750931539182446833156180324562075046720290466157035783250115573640823096586188556898039998912924797536672637411730838204990567101923783370234434666905823964654334079307640144370080226617586352634073081253538649628655468530207120820812982357408128884473437915860934508743953600412127311468958472366089248172030296810104774390085385452277616879051366259562982812318279823568098578009386689677133671783259648852073267493467034990677084625305616278812716761502320174672271353263717210043971020094307357477109297876236053815677080170766262790851439808036215387615186330788932896440288293555183072768130251204277160733652026904600950155885273799377651286502028983524972331809354723884618403396348781463477791042449292747070429844722389632958511094041622656317066100294443508518098544048767103672311566735862715349939388474113233123309435181326514095446598928066051379639195058053110058528950296350103830403961684933175157339004666689097032448316521267702557972487732943135615354935171824751875541085772751754560182419330981405897067594863516960953107649399285944893973199741517829730373433316052894139272400650803401195730560144708192355665556376685314747999718504803755782742783684055380813457892622146017013957503571675075388278787606547803135467784276963113006977309608857186469716485507079569816848670576144821092128309473490504894713909409903104556413059663718186416420838860159701782905445512197341630758526329979463100020443549293477167020072156555101956604035406633970904389056460619615586110306959876389422700845808557849078566205005570563534316643692398259276430324665771255873236960870839636692628191950680852563687630318102397508622886447452131759769441073492045365889350285443624583404490489423643903138070565215963986846902047427625648218516118565082975858593706102735421062700552704005055778747455367598462007731264271823211367486585440964119306891568240820186792769902316518428888396618834608695034877864487618852426083524092294327404769561607554429243954312552168440222973442470708842379527655620196634977093421772959044717280745198694761680172720520785648815900671851770683513220509732279910079735715802290131465034774806413097692282382847212633310198374979619125039952703502298945203497415240608812549339859410361450153860189812282094612071950956433191363097177645852598897852865287585478835340027003494918327840737355928874779324276857245402861375433120824552424839784144312853882136078457982735262318207090579575194658808781058247010758657506714173690327589147848594126846479339624976716578527841904733767416279410644627077724401374962401211216891218356934764908457590409183935973285520690138745606928057932893918440404162561839420374182131297507202441727604634395002271566619002588300726993883911828786549117823554003087946322651728691309489477089974802474484740156135615583377829618449469107568684563586714660170654898041453710841140492422180975198839304048371089158819038610661747561038380697724670777986541758426370989188329676858264520683606208990121742530348448499412261433473413651268766312640590108794491713149631998141994972001650836736510743794724009947353314603731576886311630317979673668102183487645252154244579862155561247556623597701321142805403148485703987465550166561515879443180821693368786170005748169165183114936244443881536661339926367905925316175940057321451130331585942508099250604198124558943546624995851411737303608978791885812007935635091042389837099040212981623805641663829585498411513836938644658934354532367834518642609130587265166597573254436712730990037409125065296743372087719571928520645402318470629386554496561208431532925578730332640593982413952163163657044455603069260071759444911680987478685543886631193563053524277475704790753915943931004293248269556893407962254828742622770485516321965037581156360486184044914200132704152527024375189476159013727707368120962369745764363036783208513494224351311675396963397322773158150574419237318698214853397002165187836795470579631733414855342273482746533647878861149131985254850268041327018787623603209153341242478504502578763084605014800849981480446869500971019552998840937888102076723305960651618029807383839498047787700438363341421020020401837834057173748435426916455148874976595068035179833332180179458953059013799875428560470222411721114847938862715176487795389875325758217693221103474165018738571334073298699481902593718252535284103652129150592763063903911584014017161841392404676092055139946966271040215922677560499998106301533717290355572332263213776877590676016669517245956432722590570026419888072453995969791566376856100176819910934468167494061799661426288647242194483889773147564266854386651100689640833429686149854078777571251098874841395807218594111486354606027240962510965376143982455927706063761147612456189546611267940301664941220064031764580318405873657054830740937044675886130422498599912988242466940336152485766899160026570755272496069679368538641998224967141126061792810407356967596352757903471906473733269199102738199331164486871911888824531433392485214519181627104778984090071541828444961304073954176953579822310875215271638597983591769414766266998758173002068993512675406424248377987396081263462683944999821218659250928793203139549641805589551031793555150043822301454285638338517025494873353985152062096035283910672568047484174288307254741259157872520395082804317193544338597235412371329431330875679103640006870046845466500810736945523882009543254261924687916290665252273489570354244881763941456510016428994030138035607882898304004733634446627414840978067054754544331833128753406090745057622757680420706070747162567747681882611768546194653461312981196814427367030523355738298808809305874646910068328828647002471350341589656698831866631906686130266919908281938219043929951518991585018364838581664013701790451795425065759715362355348194622311847180405111031719862502752718274439535238431261997967694488119573998146135405306445248737013730141209684645390506927544871029427825878675554354919965558455462940974769444414932590123869639439683420009129410884612324786102647516605451290024600914449956074785198507596719626763249797631590915613787053287422720180153313978208592831737605665687128730416275126524879775346419081596927689782714885127759426148490446164624138001337583656485215161618715309564784968393426575329993968547353761866250785060476438559004135835164352293664304065509576672322290380984604305450794495720980624494509729584684507634067776666571443754881509475387177504638540281325648003536925563537949722849845807145881163326685428545424706038159969139236594714438594481822656864517582249471944315411398006241028410991550111551409824242360040754506683361848380657724962513284261565580851716025366563262947449499319860956379337715654341134606450961211508034174473862466533194350709220756962062052207283874038330961111567744118992486789545599517198090081413744709552545809887931999348833682427159489416834490600465185191167862348460562511190464724124061383957986770325887770254568428128322393235493840636820845696804745059825700120668169839907825876619471550786498272332995561072567420694910104754390186144902216537835227832410636881404681912549071029986023017717150131263599599924853690113652497200112685708310413696830533526885095516003671514413953452011104524814598430202091110127513954478495622085273453800136521476508813914059364178148447766542429882967080734146042003886126614189138E-10000";

            var initialConvertedFiles = new List<BigInteger>();
            List<string> initialFilesToProcess = new List<string>
                {
                    "RanR.POC.Tests.Samples._7ZIP.Simple1.txt.7z",
                    "RanR.POC.Tests.Samples._7ZIP.Simple1.txt",
                    "RanR.POC.Tests.Samples._7ZIP.Simple3.txt.7z"
                };

            foreach (var file in initialFilesToProcess)
            {
                using (Stream stream = assembly.GetManifestResourceStream(file))
                {
                    byte[] fileBytes = new byte[stream.Length];
                    stream.Read(fileBytes, 0, fileBytes.Length);
                    initialConvertedFiles.Add(new BigInteger(fileBytes));
                }
            }

            initializer.AddFiles(initialConvertedFiles);
            initializer.InitializeSolutionGenerator(tokenSource, solutionRepository);
            while (!solutionRepository.SolutionFound)
            {
            }

            BigInteger plainText;
            using (Stream stream = assembly.GetManifestResourceStream("RanR.POC.Tests.Samples._7ZIP.Simple3.txt"))
            {
                byte[] fileBytes = new byte[stream.Length];
                stream.Read(fileBytes, 0, fileBytes.Length);
                plainText = new BigInteger(fileBytes);
            }

            var calculatedResult = SolutionGenerator.ExecuteSolution(solutionRepository.IdentifiedSolution);

            Assert.AreEqual(plainText, calculatedResult);
        }

        [TestMethod]
        public void generate_and_execute_found_solution_for_complex_file_with_provided_x()
        {
            var tokenSource = new CancellationTokenSource();
            var token = tokenSource.Token;
            var solutionRepository = new SolutionRepository(tokenSource);
            var assembly = Assembly.GetExecutingAssembly();
            var initializer = new Initializer();

            //Note that this is a precalculated value, so it will immediately pass
            initializer.InitialValueForX = "18459061426238511038234852407714043136953574323460827040305763351932317663611436936004639012529732335509366232568965365914863293761444871394300909909573216773958995998964255985423696366376885559757294396144335258064553472690033031829214515671113699806260773757167760788053477577530465014448800415633435175530639182996659500041138778999688746573316036320670602935206333915965340912465397298614159494103971473509120708990727936496328965801362043330145368765614816021262037078747241724622157901252988707274178393089047669005549994429191559778715876040089191397096283502746499442563960459830390707134006850709134855776765825313852670385460332091032485212677981169351131720941988971608934658843760156383592380623710194108083598966710693442672823038478927926795080933906964303747385363464469362697557074857530657078063999960450662798485174026698969855917459038651098111491016297709580399345994824891166038212377699527617657046858049729174981131624266945236222443451146412935799274844041109644097279911610539703347511581714959523289001086401122016724495879273719407274804382127447401766650680716017917470172802359105229130379803765378355725357510668540950120832512367254156709365132607643156792100103351706021730272404738188747481967990249482018900699769782058025411866404258782627467002305586501062459821861158154433053252253478789440871074944322183780530642135869301415362645409109994776404703722843249071226561772842398687890191969077273974679544544523190233342164090637904830256952036627441961849246331461402604855328081848421502830446776539302509580477798954486452696794515417906305077520066949038765205568323153093636069246538283534419446429359452542553671915471475384001627436656574569566870296490129623313569634328398828070866036817760926745899094331845937922585606721357316550129648712193749974207549073600459805746429444263338983481062089389187270064717600532896213302509073214996229100880955879839846030834499690037807482104309946822860860413735516238680695634599685335812209834313685482530000467375965960810753967116357405511257034805478340573007862239921719989833065113847632681661760365217079394937656096937828425067206093259903470571490224278071657822748157921157148382791217289276883659185400600006093025713074492019667747733850188269696922848658476123428724288402593985231634835533185683281667779599375344250948857053643168517049690150991997817285004321260192455736216242314439587796081876765105466482199503489782082326948140301676491273019020214144963103371746335522496815706659915784778481966110332133334525362960650186139862915750210679255712003606233028403142408397993189469438798159927265114727136102868301834701967968263633344968325255129830097389461900052029480527113204305653991255594575175620741769988945696061871480438056449994068367325114257927240221670967712311625043047584997517659684152427080833422622199678779052395049743929115340363420925492564556329724836386405680261889573129987285321280307018334960476438151811348165389437491104951122326259492452051847653793465506003266680927492012502582981207922317780049130897312566433944123474716492830006043846822108287144886601326468910602491163681442986200865675207745586885410234226876060526044890594207674665039369084109895262244223445229237483034912989260148967996238947832859528481812231120818665670224044420075563634024243609732805530096068595551561131938070638366672514807052180985679710333305089864781909048657536721141551161389832417800302311569429463643131280367051832845026290850499224311291269751555961722556313996782887846420674486308191380855976289060717407056720358962736580116410637311233223253303717748071710905383170400424510969193621504587470730863265594539738220702995462912700725752678444077044010286987093186848579216742685873209128766825230180559512288063537053741374830011960556447313470426806277664016381184573821826603669274262850922957163518684639381703081690854357299340767169277926969839877262198564275378832489924247410358736812319622946965862116122890001577005596787942377513227056421801280017324505768890551683897650438729144262014293223451077468961962094839469288120994913113334580809194607647652232753062373500269144768026364939398476331749408574754644181198315864679299519574802223948972908149259182675384976026546738660754467103928536576292023039269866171456350983641957360697022730092680458707309147253520108456289050873917827260104718546004123140296314119750465273442815851445852137139441813893267344515652393305375514700312082451786788598390057669520037738151385627062286303089833980965363107740221898424503718511168840065784522549771505197646502486418571615631340038643835101284277637049141477216539254820168349597089627304800537618213612153869057848570819779680682738648253308493150653640349361165366939223462435889237194451818133355989313074269129897143607425443931099928745553935349987236353112191005521672379045445772898544370461879886627321368761911586232490256217416081645095928033591412659101096934939218463388875318705967175809898264591076631870092675061050584739603084296392969490464939372078721811838685895474417476299410283795024270949638194810456154132502082088527209961517071679648350569681702208093790009706297392831099130236364086860836996418857816842903993988639491001709832520233003169339825766522436590320570909211046616423252154358481826541680727907171531741753986480543826595459944197108372619354305298768673141413831402977068552192237765811112386708790714601321624737192741974912538573865081760481432202883994953592134396821482783261639823179860257546567104971973211988228252633262841595167496195470231282438858998709876922501889714064412074237318962286901584687632953393603552037420265434200071289745555831403899710005584642052189073558013137806842539193258290934004945768597744974108976815265254042312022936208695153195621919111308748954012744021248306592476202311371272473578660232889134170851478293124455007635896382038706861352784856869369155884475582562720436318203126321271671331304327519039852785432399129800994337275315244509415307314627284543214408617175879743088149354256062560652409562462267824331829152716230017843307691440357575598404616469097845645275846204148563563945323453540891240047809158217946972452975076317408108363506094485944268053304926627196104142616841064892633203027725661192265496492650768758365633398397992040430281184912126419430505829270009135639446400377381410476971195557720262222169256787616392706645836828578610756628233644812934995533389051411271079708356933305672290192486363044332398805340586431255817023198226190082631386047193252222064902979550304033555695337912343261949415609823356224989844893798714604783587049615260364731242276980535897565996758071439184895605709768528217045595803993723950537835495551375949005847368797435404087363449773708157957906285745711948806004956083786822564597550031118245776995460526845155093434216650042618670147846548888090320574365336979399555578308834318936542687836728955155441771823395835242031358597150040561085639642540619417266742818004661826349371863692367826716973224564814372945874323763800324104577276740096653160892712149575150564320754061954753509024265836314436375132418493312587619557090802974440714797649029362422064842540261623948834396260904919177211931270393951246988598265866778428773753336150580749555798511919251735031708809089503351214808182812693368092639719133487286485426077038600070606750620222441861590799920642735234536639527646090651946484603003474812071082580009826395061453953198912125469446092527306429102379151376476241148081773739981143857839940947000419589354453102658430207591676734728908774189272204513394953541363818940618941704072511973466465288844221680141913829991118952257617136256844913212626394833771547283920546801937390370180449066600568029697737891418574412558594914725176375421825376040071574668787577868346333290147363723173994951325651176402980082817490201530953589244995004198628146772731001931208511770310726553502440137391380117131060253139201548848151195598012440696645095729393391573661810495705126360266839410605450154989608487553725497025970205193423816682010910547564493803440177876501625231408893066686219424632959252993717886747933187508180174832800661997774537255274058481831442621470477950727971708893499931463978078966380707982137651638109972452986801089975830898864599898144390866944579416509791341493267319510643051513732554557338126871152220624511668223939410079636926930885274809233909318490819254844208669509150223782304175150372627016725459341073611125400434434134151492926478366167393148121925471358926039115787269720422351407898309636951344027089987575463496193503444121948943621307497190376484836271881750400485628559454025577803466739319622577545864699038185693217383138695049734431901594980206758747303440717951409908005053589681150975619206814467783142785399973275990398628094425268916030979856688410078662469155687900610450897779529350418995795691994974246388182828126265329834576558716347879566444723377599242193689671402768525045533707495295870253945545467423684430019372878801532867495696818662880278517866337387354563747832292536643928670175616933574422253842069720493384395897125947846021847218596632866605181500423694821244792170202237820707334940771857604111252996567251327999637477359405135435797299823030821104021206618415379927086526659812897700433307881347861562523017102689484417549659365476739087011581519643420438466429341410480868836720137362654596518137031186123240208271631742452449013543135359950791602376089841993434755673684664403266231210011333059951488272698692009094405099637134379887403097659087855040679353075381851386785191417335730743368187535532097964648808006174534888183950626399652066022709387629528262082651728900493936140706334069270508464550226058583559666839011839700943658942687178382743394030851397522755003635760812574694121730156608710441843476906990123720558509425671709297849878518302002490809558599433232533939183319908702917478018604135311373250897816713908590767903190765634407514418924855512749925782525590179884416369616076843445806689624348090210063925426949513825487160178E-9981";

            var initialConvertedFiles = new List<BigInteger>();
            List<string> initialFilesToProcess = new List<string>
                {
                    "RanR.POC.Tests.Samples._7ZIP.Complex1.txt.7z",
                    "RanR.POC.Tests.Samples._7ZIP.Complex1.txt",
                    "RanR.POC.Tests.Samples._7ZIP.Complex2.txt.7z"
                };

            foreach (var file in initialFilesToProcess)
            {
                using (Stream stream = assembly.GetManifestResourceStream(file))
                {
                    byte[] fileBytes = new byte[stream.Length];
                    stream.Read(fileBytes, 0, fileBytes.Length);
                    initialConvertedFiles.Add(new BigInteger(fileBytes));
                }
            }

            initializer.AddFiles(initialConvertedFiles);
            initializer.InitializeSolutionGenerator(tokenSource, solutionRepository);
            while (!solutionRepository.SolutionFound)
            {
            }

            BigInteger plainText;
            using (Stream stream = assembly.GetManifestResourceStream("RanR.POC.Tests.Samples._7ZIP.Complex2.txt"))
            {
                byte[] fileBytes = new byte[stream.Length];
                stream.Read(fileBytes, 0, fileBytes.Length);
                plainText = new BigInteger(fileBytes);
            }

            var calculatedResult = SolutionGenerator.ExecuteSolution(solutionRepository.IdentifiedSolution);

            Assert.AreEqual(plainText, calculatedResult);
        }

        [TestMethod]
        public void generate_and_execute_solution_for_simple_file_without_providing_x()
        {
            var tokenSource = new CancellationTokenSource();
            var token = tokenSource.Token;
            var solutionRepository = new SolutionRepository(tokenSource);
            var assembly = Assembly.GetExecutingAssembly();
            var initializer = new Initializer();



            var initialConvertedFiles = new List<BigInteger>();
            List<string> initialFilesToProcess = new List<string>
                {
                    "RanR.POC.Tests.Samples._7ZIP.Simple1.txt.7z",
                    "RanR.POC.Tests.Samples._7ZIP.Simple1.txt",
                    "RanR.POC.Tests.Samples._7ZIP.Simple3.txt.7z"
                };

            foreach (var file in initialFilesToProcess)
            {
                using (Stream stream = assembly.GetManifestResourceStream(file))
                {
                    byte[] fileBytes = new byte[stream.Length];
                    stream.Read(fileBytes, 0, fileBytes.Length);
                    initialConvertedFiles.Add(new BigInteger(fileBytes));
                }
            }

            var tempSolution = new Solution((initialConvertedFiles[0], initialConvertedFiles[1]), initialConvertedFiles[2]);
            initializer.AddFiles(initialConvertedFiles);
            initializer.InitializeSolutionGenerator(tokenSource, solutionRepository);
            while (!solutionRepository.SolutionFound)
            {
            }

            BigInteger plainText;
            using (Stream stream = assembly.GetManifestResourceStream("RanR.POC.Tests.Samples._7ZIP.Simple3.txt"))
            {
                byte[] fileBytes = new byte[stream.Length];
                stream.Read(fileBytes, 0, fileBytes.Length);
                plainText = new BigInteger(fileBytes);
            }

            var calculatedResult = SolutionGenerator.ExecuteSolution(solutionRepository.IdentifiedSolution);

            Assert.AreEqual(plainText, calculatedResult);
        }
    }
}

